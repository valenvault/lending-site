<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø³Ø§Ù…Ø§Ù†Ù‡ ÙˆØ§Ù…â€ŒØ¯Ù‡ÛŒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet" />

  <style>
    /* Base */
    :root {
      --bg: #f8f9fa;
      --fg: #222;
      --card-bg: #fff;
      --card-border: #ddd;
      --input-bg: #fff;
      --input-fg: #222;
      --input-border: #ced4da;
      --placeholder: #888;
      --accent: #0d6efd;
    }
    body {
      background-color: var(--bg);
      color: var(--fg);
      font-family: Vazir, sans-serif;
      transition: background-color 0.25s ease, color 0.25s ease;
    }
    /* Ø­Ø§Ù„Øª ØªØ§Ø±ÛŒÚ© Ø¨Ø±Ø§ÛŒ label */
body.dark label {
  color: #f0f0f0;
}

/* Ø­Ø§Ù„Øª ØªØ§Ø±ÛŒÚ© Ø¨Ø±Ø§ÛŒ placeholder */
body.dark .form-control::placeholder {
  color: #aaa;
}
body.dark .form-label {
  color: #f0f0f0;
}
    .card {
      background-color: var(--card-bg);
      border-color: var(--card-border);
    }
    .form-control {
      background-color: var(--input-bg);
      color: var(--input-fg);
      border-color: var(--input-border);
    }
    .form-control::placeholder { color: var(--placeholder); }
    .table { color: inherit; }
    .table-responsive { overflow-x: auto; }
    .card-header { font-weight: 700; }

    /* Dark mode */
    body.dark {
      --bg: #121212;
      --fg: #f0f0f0;
      --card-bg: #1a1a1a;
      --card-border: #333;
      --input-bg: #1f1f1f;
      --input-fg: #f0f0f0;
      --input-border: #444;
      --placeholder: #aaa;
      --accent: #0aa8ff;
    }
    body.dark .table {
      background-color: #1a1a1a;
      border: 2px solid #b30000;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.25);
    }
    body.dark .table th, body.dark .table td {
      background-color: #1a1a1a;
      border: 1px solid #b30000;
      padding: 8px;
    }

    /* Device badges (visual cue, optional) */
    body.android { border-top: 4px solid #2e7d32; } /* green */
    body.ios { border-top: 4px solid #1565c0; }     /* blue */
    body.desktop { border-top: 4px solid #6c757d; } /* gray */

    /* Responsive layout */
    /* Mobile */
    @media (max-width: 767px) {
      .card { width: 100%; margin: 0 auto 1rem; }
      .form-control, .btn { font-size: 16px; }
      .btn { width: 100%; }
      .container { padding: 0 0.5rem; }
    }
    /* Tablet */
    @media (min-width: 768px) and (max-width: 1024px) {
      .card { width: 90%; margin: 0 auto 1rem; }
      .form-control, .btn { font-size: 15px; }
    }
    /* Desktop */
    @media (min-width: 1025px) {
      .card { width: 900px; margin: 0 auto 1.25rem; }
      .form-control, .btn { font-size: 14px; }
    }

    /* Device-specific tweaks */
    body.android .btn-warning { font-size: 16px; }
    body.desktop .btn-warning { font-size: 14px; }
  </style>
</head>

<body class="container py-4">
  <!-- Header actions -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="m-0">Ø³Ø§Ù…Ø§Ù†Ù‡ ÙˆØ§Ù…â€ŒØ¯Ù‡ÛŒ</h5>
    <div class="d-flex gap-2">
      <button id="toggleMode" class="btn btn-outline-secondary">ØªØºÛŒÛŒØ± Ø­Ø§Ù„Øª ØªØ§Ø±ÛŒÚ©/Ø±ÙˆØ´Ù†</button>
      <button id="systemMode" class="btn btn-outline-primary">Ù‡Ù…Ú¯Ø§Ù… Ø¨Ø§ Ø³ÛŒØ³ØªÙ…</button>
    </div>
  </div>

  <!-- Borrower -->
  <div class="card shadow mb-4">
    <div class="card-header bg-primary text-white">ÙˆØ§Ù…â€ŒÚ¯ÛŒØ±Ù†Ø¯Ù‡</div>
    <div class="card-body">
      <form id="borrowerForm" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Ù†Ø§Ù…</label>
          <input type="text" name="name" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Ú©ÛŒÙ Ù¾ÙˆÙ„</label>
          <input type="text" name="wallet" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 0x..." required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Ù…Ø¨Ù„Øº ÙˆØ§Ù…</label>
          <input type="number" name="amount" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 1000" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Ù†ÙˆØ¹ ÙˆØ«ÛŒÙ‚Ù‡</label>
          <input type="text" name="collateralType" class="form-control" placeholder="Ù…Ø«Ø§Ù„: BTC / ETH / USDT" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Ø§Ø±Ø²Ø´ ÙˆØ«ÛŒÙ‚Ù‡</label>
          <input type="number" name="collateralValue" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 1200" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Ù…Ø¯Øª ÙˆØ§Ù… (Ù…Ø§Ù‡)</label>
          <input type="number" name="duration" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 6" />
        </div>
        <div class="col-12">
          <button type="button" class="btn btn-primary"
            onclick="submitForm('borrowerForm','/api/borrower','borrowerResult')">
            Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆØ§Ù…
          </button>
        </div>
      </form>
      <div id="borrowerResult" class="mt-3"></div>
    </div>
  </div>

  <!-- Lender -->
  <div class="card shadow mb-4">
    <div class="card-header bg-success text-white">ÙˆØ§Ù…â€ŒØ¯Ù‡Ù†Ø¯Ù‡</div>
    <div class="card-body">
      <form id="lenderForm" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Ù†Ø§Ù…</label>
          <input type="text" name="name" class="form-control" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Ú©ÛŒÙ Ù¾ÙˆÙ„</label>
          <input type="text" name="wallet" class="form-control" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Ù…Ø¨Ù„Øº</label>
          <input type="number" name="amount" class="form-control" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Ù…Ø¯Øª</label>
          <input type="number" name="duration" class="form-control" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Ø¨Ù‡Ø±Ù‡</label>
          <input type="number" name="interest" class="form-control" />
        </div>
        <div class="col-12">
          <button type="button" class="btn btn-success"
            onclick="submitForm('lenderForm','/api/lender','lenderResult')">
            Ø«Ø¨Øª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ ÙˆØ§Ù…
          </button>
        </div>
      </form>
      <div id="lenderResult" class="mt-3"></div>

      <!-- Orders -->
      <div class="card shadow mt-4">
        <div class="card-header bg-warning">ğŸ“‹ Ø³ÙØ§Ø±Ø´Ø§Øª Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</div>
        <div class="card-body">
          <button onclick="showOrders()" class="btn btn-warning mb-3">Ù†Ù…Ø§ÛŒØ´ Ø³ÙØ§Ø±Ø´Ø§Øª</button>
          <div id="ordersList" class="table-responsive"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Device detection and mode handling
    function detectDevice() {
      const ua = navigator.userAgent.toLowerCase();

      // Device classes
      if (ua.includes('android')) {
        document.body.classList.add('android');
      } else if (ua.includes('iphone') || ua.includes('ipad') || ua.includes('ipod')) {
        document.body.classList.add('ios');
      } else if (ua.includes('mobile')) {
        // Fallback for mobile-only UA strings
        document.body.classList.add('android');
      } else {
        document.body.classList.add('desktop');
      }

      // Optional: auto-dark on mobile devices
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isMobile = document.body.classList.contains('android') || document.body.classList.contains('ios');
      if (isMobile && prefersDark) {
        document.body.classList.add('dark');
      }
    }

    // System theme sync
    function applySystemTheme() {
      if (!window.matchMedia) return;
      const mq = window.matchMedia('(prefers-color-scheme: dark)');
      const apply = () => {
        // Only change if "system sync" is active
        if (localStorage.getItem('theme') === 'system') {
          document.body.classList.toggle('dark', mq.matches);
        }
      };
      mq.addEventListener ? mq.addEventListener('change', apply) : mq.addListener(apply);
      apply();
    }

    // Manual toggle
    function bindThemeControls() {
      const toggleBtn = document.getElementById('toggleMode');
      const systemBtn = document.getElementById('systemMode');

      toggleBtn.addEventListener('click', () => {
        const newDark = !document.body.classList.contains('dark');
        document.body.classList.toggle('dark', newDark);
        localStorage.setItem('theme', newDark ? 'dark' : 'light');
      });

      systemBtn.addEventListener('click', () => {
        localStorage.setItem('theme', 'system');
        applySystemTheme();
      });

      // Load persisted preference
      const saved = localStorage.getItem('theme');
      if (saved === 'dark') document.body.classList.add('dark');
      else if (saved === 'light') document.body.classList.remove('dark');
      else if (saved === 'system') applySystemTheme();
    }

    // Submit form helper
    async function submitForm(formId, apiUrl, resultId) {
      const form = document.getElementById(formId);
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      try {
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error('Server error');

        const result = await res.json();
        document.getElementById(resultId).innerHTML =
          `<div class="alert alert-success">Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø«Ø¨Øª Ø´Ø¯ âœ…</div>`;
        form.reset();
      } catch (err) {
        document.getElementById(resultId).innerHTML =
          `<div class="alert alert-danger">Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª âŒ</div>`;
      }
    }

    // Fetch and render orders
    async function showOrders() {
      try {
        const res = await fetch('/api/orders');
        if (!res.ok) throw new Error('Server error');
        const orders = await res.json();

        if (!orders.length) {
          document.getElementById('ordersList').innerHTML =
            `<div class="alert alert-info">Ù‡ÛŒÚ† Ø³ÙØ§Ø±Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>`;
          return;
        }

        const table = `
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th>Ø´Ù†Ø§Ø³Ù‡</th>
                <th>Ù†ÙˆØ¹</th>
                <th>Ù†Ø§Ù…</th>
                <th>Ú©ÛŒÙ Ù¾ÙˆÙ„</th>
                <th>Ù…Ø¨Ù„Øº</th>
                <th>Ù†ÙˆØ¹ ÙˆØ«ÛŒÙ‚Ù‡</th>
                <th>Ø§Ø±Ø²Ø´ ÙˆØ«ÛŒÙ‚Ù‡</th>
                <th>Ù…Ø¯Øª</th>
                <th>Ø¨Ù‡Ø±Ù‡</th>
                <th>Ú©Ø§Ø±Ù…Ø²Ø¯</th>
                <th>Ù…Ø¬Ù…ÙˆØ¹</th>
                <th>ØªØ§Ø±ÛŒØ®</th>
              </tr>
            </thead>
            <tbody>
              ${orders.map(o => `
                <tr>
                  <td>${o.id}</td>
                  <td>${o.type || '-'}</td>
                  <td>${o.name || '-'}</td>
                  <td>${o.wallet || '-'}</td>
                  <td>${o.amount ?? '-'}</td>
                  <td>${o.collateralType || '-'}</td>
                  <td>${o.collateralValue ?? '-'}</td>
                  <td>${o.duration ?? '-'}</td>
                  <td>${o.interest ?? '-'}</td>
                  <td>${o.feeAmount ?? '-'}</td>
                  <td>${o.total ?? '-'}</td>
                  <td>${o.date}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        document.getElementById('ordersList').innerHTML = table;
      } catch (err) {
        document.getElementById('ordersList').innerHTML =
          `<div class="alert alert-danger">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´Ø§Øª âŒ</div>`;
      }
    }

    // Init
    detectDevice();
    bindThemeControls();
  </script>
</body>
</html>
